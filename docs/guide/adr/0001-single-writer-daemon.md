# ADR-0001: 单写者 Daemon 架构

## 状态

**Accepted** (2025-12)

---

## 上下文

MCPAgents 需要支持多个客户端（GUI、CLI、Termux 远程）同时访问和操作：

- 会话数据 (chats, messages)
- 配置数据 (providers, routing)
- 运行时状态 (runs, events)

传统方案是让每个客户端直接读写 SQLite 数据库，但这会导致：

1. **并发写入冲突**: SQLite 不支持高并发写入，容易锁表
2. **状态不一致**: 多个客户端的本地缓存难以同步
3. **事件丢失**: 没有统一的事件源，难以实现实时推送
4. **离线/在线切换复杂**: 每个客户端都要处理冲突合并

---

## 决策

**采用"单写者 Daemon"架构**:

1. 所有数据库写入只能通过 Daemon (`mcpagentsd`) 进行
2. 客户端通过 HTTP REST API 发送写请求
3. 客户端通过 SSE 订阅实时事件
4. Daemon 使用进程锁确保全局单实例

```
┌─────────────────────────────────────────────────────────────┐
│                    mcpagentsd (单写者)                       │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐│
│  │ HTTP Router │ │ EventService│ │   SQLite (唯一写者)      ││
│  └─────────────┘ └─────────────┘ └─────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
         ↑                ↑                    ↑
    ┌────┴────┐     ┌─────┴─────┐      ┌──────┴──────┐
    │   GUI   │     │    CLI    │      │   Termux    │
    │(只读DB) │     │ (无本地DB)│      │  (远程)     │
    └─────────┘     └───────────┘      └─────────────┘
```

---

## 理由

### 为什么不是"多写者 + CRDT"？

| 考量 | 单写者 | 多写者 + CRDT |
|------|--------|---------------|
| 实现复杂度 | 低 | 高 |
| 数据一致性 | 强一致 | 最终一致 |
| 冲突解决 | 无冲突 | 需要合并策略 |
| 事件顺序 | 全局有序 | 需要向量时钟 |
| SQLite 兼容 | 原生支持 | 需要改造 |

对于桌面应用场景，强一致性比最终一致性更重要（用户期望"保存即生效"）。

### 为什么不是"每个客户端独立 DB + 同步"？

1. 同步冲突难以自动解决（尤其是会话合并）
2. 需要复杂的同步协议（如 CouchDB 式）
3. 存储膨胀（每个设备一份完整数据）

### 为什么选择进程锁而不是端口检测？

进程锁（Windows Named Mutex / Linux flock）比端口检测更可靠：

- 端口检测可能误判（另一个应用占用同端口）
- 进程崩溃后端口可能延迟释放
- 进程锁在进程退出时自动释放

---

## 后果

### 正面影响

1. **数据一致性保证**: 所有写入串行化，不存在并发冲突
2. **事件流可靠**: 单一事件源，seq 单调递增，支持断线续传
3. **离线模式简化**: GUI 可以有本地只读缓存，重连后从 Daemon 同步
4. **调试简化**: 所有状态变更都有审计日志

### 负面影响

1. **单点故障**: Daemon 崩溃会影响所有客户端
   - 缓解：系统托盘自动重启、systemd 守护
2. **额外进程开销**: 需要常驻一个后台服务
   - 缓解：Dart AOT 编译后内存占用 < 50MB
3. **本地 API 延迟**: 所有操作都要走 HTTP
   - 缓解：localhost 通信延迟 < 1ms

### 需要注意

- GUI 离线模式只能读取本地缓存，不能创建新会话
- CLI 必须先启动 Daemon 才能工作
- 跨设备同步需要额外的 P2P 协议（未来考虑）

---

## 代码位置

- 进程锁: `apps/mcpagentsd/lib/src/services/lock_service.dart`
- 数据库服务: `apps/mcpagentsd/lib/src/services/database_service.dart`
- HTTP 路由: `apps/mcpagentsd/lib/src/router.dart`

---

## 参考

- [SQLite 并发限制](https://www.sqlite.org/lockingv3.html)
- [Event Sourcing Pattern](https://martinfowler.com/eaaDev/EventSourcing.html)
